<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Tienda de Fortnite â€” iEvan709</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Tienda diaria de Fortnite con precios, rarezas y filtros. Actualizada automÃ¡ticamente." />
  <meta property="og:title" content="Tienda de Fortnite â€” iEvan709" />
  <meta property="og:description" content="Tienda diaria de Fortnite con precios, rarezas y filtros. Actualizada automÃ¡ticamente." />
  <meta property="og:type" content="website" />
  <!-- Evita el 404 del favicon -->
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg:#0b0f1a; --panel:#111726; --card:#141c2e;
      --txt:#e8ecf1; --muted:#9fb0c7;
      --rare-common:#888; --rare-uncommon:#29c059; --rare-rare:#3a82ff; --rare-epic:#a45bff; --rare-legendary:#ff8f2b; --rare-mythic:#ffd400;
      --ring: 10px;
      --accent:#2b57a3; --chip:#1a2236;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f1a,#0d1324 40%,#0b0f1a);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans',sans-serif}
    .wrap{max-width:1100px;margin:auto;padding:20px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .title h1{font-size:22px;margin:0}
    .title small{color:var(--muted)}
    .legend{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;background:var(--chip);color:#cfe0ff;cursor:pointer;border:1px solid #243150;font-size:13px}
    .chip.active{background:#244077;color:#fff;border-color:#2b57a3}

    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap:12px; }
    .card{
      background:var(--card); border-radius:14px; overflow:hidden; border:1px solid #1b2440;
      display:flex; flex-direction:column; min-height:240px; position:relative;
    }
    .thumb{ position:relative; width:100%; padding-top:100%; background:linear-gradient(180deg,#0f1629,#0a1124); overflow:hidden; }
    .thumb img{ position:absolute; top:7%; left:7%; width:86%; height:86%; object-fit:contain; max-width:100%; max-height:100%; image-rendering:-webkit-optimize-contrast; }

    .dots{position:absolute;bottom:6px;left:0;right:0;display:flex;justify-content:center;gap:6px}
    .dot{width:6px;height:6px;border-radius:50%;background:#94a3b833}
    .dot.active{background:#cbd5e1}

    .price{position:absolute;left:8px;top:8px;background:#101827cc;border:1px solid #1f2c4d;color:#fff;padding:4px 7px;border-radius:8px;font-size:12px;z-index:2}
    .badge{position:absolute;right:8px;top:8px;padding:4px 7px;border-radius:8px;border:1px solid #1f2c4d;background:#101827cc;font-size:12px;z-index:2}
    .meta{padding:10px 10px 12px}
    .name{font-size:14px;font-weight:600;line-height:1.2;margin-bottom:6px;min-height:34px}
    .sub{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:8px}
    .ring{position:absolute;inset:0;pointer-events:none;border-radius:14px}
    .ring.common     {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-common) 46%, transparent)}
    .ring.uncommon   {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-uncommon) 38%, transparent)}
    .ring.rare       {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-rare) 34%, transparent)}
    .ring.epic       {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-epic) 34%, transparent)}
    .ring.legendary  {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-legendary) 32%, transparent)}
    .ring.mythic     {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-mythic) 30%, transparent)}
    .empty{opacity:.6}
    footer{margin:28px 0 8px;color:var(--muted);font-size:12px}

    .viewbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:4px 0 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Tienda de Fortnite</h1>
        <small id="date">Cargandoâ€¦</small>
      </div>
      <div class="legend" id="typebar">
        <span class="chip active" data-filter="all">Todo</span>
        <span class="chip" data-filter="traje">Traje</span>
        <span class="chip" data-filter="gesto">Gesto</span>
        <span class="chip" data-filter="pico">Pico</span>
        <span class="chip" data-filter="ala-delta">Ala delta</span>
        <span class="chip" data-filter="envoltorio">Envoltorio</span>
        <span class="chip" data-filter="mochila">Mochila</span>
        <span class="chip" data-filter="companero">CompaÃ±ero</span>
        <span class="chip" data-filter="pista">Pistas</span>
      </div>
    </header>

    <div class="legend" style="margin:10px 0 8px">
      <span class="dot" style="background:var(--rare-common)"></span> ComÃºn
      <span class="dot" style="background:var(--rare-uncommon)"></span> Poco comÃºn
      <span class="dot" style="background:var(--rare-rare)"></span> Raro
      <span class="dot" style="background:var(--rare-epic)"></span> Ã‰pico
      <span class="dot" style="background:var(--rare-legendary)"></span> Legendario
      <span class="dot" style="background:var(--rare-mythic)"></span> MÃ­tico
    </div>

    <!-- Toggle de vista (solo en â€œTodoâ€) -->
    <div class="viewbar" id="viewbar">
      <span class="chip chip-view active" data-view="groups">Lotes</span>
      <span class="chip chip-view" data-view="individual">Individual</span>
    </div>

    <!-- Filtros secundarios (solo para Individual) -->
    <div class="toolbar" id="tool-individual" style="display:none">
      <span class="chip" id="only-priced">Nuevos</span>
    </div>

    <section class="grid" id="grid"></section>

    <footer>Fuente: Fortnite-API Â· Render por iEvan709</footer>
  </div>

<script>
'use strict';

// ---------- DOM ----------
const grid   = document.getElementById('grid');
const dateEl = document.getElementById('date');
const typeChips = [...document.querySelectorAll('.chip[data-filter]')];
const viewChips = [...document.querySelectorAll('.chip-view')];
const viewBar   = document.getElementById('viewbar');

// Soportar ambos ids para tu chip: only-new (preferido) o only-priced (legacy)
const newChip = document.getElementById('only-new') || document.getElementById('only-priced');
const toolInd = document.getElementById('tool-individual');

// ---------- Estado ----------
let FILTER = 'all';        // 'all' | 'traje' | 'gesto' | ...
let VIEW   = 'groups';     // 'groups' | 'individual'
let ONLY_NEW = false;      // "Nuevos"

// Datos en memoria
const DATA = { items: [], groups: [] };
const GROUP_SIZE  = new Map(); // groupId -> cantidad de Ã­tems
const GROUP_PRICE = new Map(); // groupId -> precio de lote

// ---------- Orden ----------
const RARITY_ORDER = { mythic:0, legendary:1, epic:2, rare:3, uncommon:4, common:5 };
const TYPE_ORDER   = { traje:0, gesto:1, pico:2, 'ala-delta':3, envoltorio:4, mochila:5, companero:6, pista:7 };
const secOrder = s => ({'Featured':0,'Special Featured':1,'Special Daily':2,'Daily':3,'Votes':4,'Vote Winners':5})[s] ?? 9;
const cmp = (a,b)=> a<b?-1:a>b?1:0;

// ---------- Helpers ----------
function priceFmt(p){
  if (p == null || p === "") return "Â¿?";
  const s = String(p); return /^\d+$/.test(s) ? `${s} V-Bucks` : s;
}
function rarityLabel(r){
  const map = {common:"ComÃºn",uncommon:"Poco comÃºn",rare:"Raro",epic:"Ã‰pico",legendary:"Legendario",mythic:"MÃ­tico"};
  return map[r] || r || "â€”";
}
function normalizeType(obj){
  let t = (obj.type || '').toString().toLowerCase().replace('_','-').trim();
  if (!t) {
    const n = (obj.name||'').toLowerCase();
    if (/(compaÃ±er|compan|buddy|pet)/.test(n)) t = 'companero';
    else if (/(pista|improvis|jam|track|music|mÃºsica|musica)/.test(n))  t = 'pista';
    else if (/(gesto|emote|baile|dance)/.test(n))                      t = 'gesto';
    else if (/(pico|hacha|pickaxe)/.test(n))                           t = 'pico';
    else if (/(ala delta|ala|glider|planeador)/.test(n))               t = 'ala-delta';
    else if (/(envoltorio|wrap|camo)/.test(n))                         t = 'envoltorio';
    else if (/(mochila|back bling|backbling|accesorio)/.test(n))       t = 'mochila';
    else t = 'traje';
  }
  if (t === 'ala_delta') t = 'ala-delta';
  if (t === 'mascota')   t = 'companero';
  return t;
}

// De momento, hasta conectar el endpoint de "nuevos", lo dejamos neutro.
// MaÃ±ana aquÃ­ usaremos json de /v2/cosmetics/new o flags (added, unseenFor, etc.)
function isNew(it){
  return !!it.isNew; // hoy todos false => no rompe nada
}

// Precio efectivo para Individual
function effectiveItemPrice(it){
  const gid    = it.groupId;
  const gsize  = GROUP_SIZE.get(gid) || 0;
  const gprice = GROUP_PRICE.get(gid);

  // preferir precio individual si existe y es distinto al del lote
  if (it.price != null && it.price !== '' && String(it.price) !== String(gprice)) return it.price;

  // si el lote contiene 1 Ã­tem, aceptar precio del lote (casos â€œskin + algo inseparableâ€)
  if (gsize === 1 && (it.price == null || it.price === '')) return gprice ?? it.groupPrice ?? null;

  // si no hay precio individual vÃ¡lido y el grupo tiene >1 Ã­tem, es solo en lote
  return null;
}

// ---------- UI: eventos ----------
typeChips.forEach(ch => ch.addEventListener('click', () => {
  typeChips.forEach(c => c.classList.remove('active'));
  ch.classList.add('active');
  FILTER = ch.dataset.filter;

  // La barra Lotes/Individual solo en â€œTodoâ€; fuera de ahÃ­ forzamos Individual
  if (FILTER === 'all') {
    VIEW = document.querySelector('.chip-view.active')?.dataset.view || 'groups';
    viewBar.style.display = 'flex';
  } else {
    VIEW = 'individual';
    viewChips.forEach(c => c.classList.remove('active'));
    document.querySelector('.chip-view[data-view="individual"]')?.classList.add('active');
    viewBar.style.display = 'none';
    // ðŸ”½ NUEVO: al salir de "Todo", apagar "Nuevos"
    ONLY_NEW = false;
    newChip?.classList.remove('active');
  }
  render();
}));

viewChips.forEach(ch => ch.addEventListener('click', () => {
  if (FILTER !== 'all') return; // seguridad extra
  viewChips.forEach(c => c.classList.remove('active'));
  ch.classList.add('active');
  VIEW = ch.dataset.view;

  // ðŸ”½ NUEVO: si pasamos a "groups" (Lotes), desactivar "Nuevos"
  if (VIEW === 'groups') {
    ONLY_NEW = false;
    newChip?.classList.remove('active');
  }
  
  render();
}));

if (newChip){
  newChip.addEventListener('click', () => {
    ONLY_NEW = !ONLY_NEW;
    newChip.classList.toggle('active', ONLY_NEW);
    render();
  });
}

// ---------- Cards ----------
function cardItem(it){
  const rar = (it.rarity||"common").toLowerCase();
  const ty  = normalizeType(it);
  if (FILTER !== 'all' && ty !== FILTER) return '';

  // En Individual, ocultar Ã­tems sin precio efectivo
  const p = effectiveItemPrice(it);
  if ((VIEW === 'individual' || FILTER !== 'all') && p == null) return '';

  const exp = it.expires || it.expiresISO || '';
  return `
  <article class="card" data-type="${ty}">
    <div class="ring ${rar}"></div>
    <div class="thumb">
      <img loading="lazy" src="${it.image || it.img_url}" alt="${it.name}"
           onerror="this.closest('article').classList.add('empty')" />
      <span class="price">${priceFmt(p)}</span>
      <span class="badge">${rarityLabel(rar)}</span>
    </div>
    <div class="meta">
      <div class="name">${it.name}</div>
      <div class="sub">
        <span>${ty}${it.group ? ` Â· ${it.group}`:''}</span>
        <span>${exp ? `Sale: ${exp}` : ''}</span>
      </div>
    </div>
  </article>`;
}

function cardGroup(g){
  if (FILTER !== 'all') return '';
  const total = (g.items||[]).length;
  const name  = g.name ? `${g.name} (Lote)` : `${(g.items?.[0]?.name)||'Lote'} (Lote)`;
  const rar   = ((g.items && g.items[0] && g.items[0].rarity) || 'common').toLowerCase();
  const exp   = g.expires || g.expiresISO || '';
  const pics  = (g.images && g.images.length ? g.images : (g.items||[]).map(x=>x.image)).filter(Boolean).slice(0,8);
  const lead  = pics[0] || '';

  return `
  <article class="card" data-type="lote" data-id="${g.id}" data-pics='${JSON.stringify(pics).replace(/'/g,"&#39;")}'>
    <div class="ring ${rar}"></div>
    <div class="thumb">
      <img class="slide" loading="lazy" src="${lead}" alt="${name}"
           onerror="this.closest('article').classList.add('empty')" />
      <span class="price">${priceFmt(g.price)}</span>
      <span class="badge">Lote Â· ${total} item${total===1?'':'s'}</span>
      <div class="dots">${pics.map((_,i)=>`<span class="dot ${i===0?'active':''}"></span>`).join('')}</div>
    </div>
    <div class="meta">
      <div class="name">${name}</div>
      <div class="sub">
        <span>Incluye ${total}</span>
        <span>${exp ? `Sale: ${exp}` : ''}</span>
      </div>
    </div>
  </article>`;
}

// ---------- Sort ----------
function sortItems(a,b){
  const sa = secOrder(a.section||''), sb = secOrder(b.section||'');
  if (sa !== sb) return sa - sb;
  const ta = TYPE_ORDER[normalizeType(a)] ?? 99;
  const tb = TYPE_ORDER[normalizeType(b)] ?? 99;
  if (ta !== tb) return ta - tb;
  const ra = RARITY_ORDER[(a.rarity||'').toLowerCase()] ?? 9;
  const rb = RARITY_ORDER[(b.rarity||'').toLowerCase()] ?? 9;
  if (ra !== rb) return ra - rb;
  return cmp((a.name||'').toLowerCase(), (b.name||'').toLowerCase());
}
function sortGroups(a,b){
  const pa = a.price ?? 9e9, pb = b.price ?? 9e9;
  if (pa !== pb) return pa - pb;
  return cmp((a.name||'').toLowerCase(), (b.name||'').toLowerCase());
}

// ---------- Render ----------
function render(){
  // Mostrar barra Lotes/Individual solo en â€œTodoâ€
  viewBar.style.display = (FILTER === 'all') ? 'flex' : 'none';
  // Toolbar (Nuevos) visible Ãºnicamente si: (Todo + Individual)
  toolInd.style.display = (FILTER === 'all' && VIEW === 'individual') ? 'block' : 'none';

  if (FILTER !== 'all') {
    // Fuera de â€œTodoâ€: SIEMPRE Individual y SIN lotes
    const items = DATA.items
      .filter(it => normalizeType(it) === FILTER)
      .filter(it => effectiveItemPrice(it) != null)
      .sort(sortItems);
    grid.innerHTML = items.map(cardItem).join('') || `<p class="empty">Sin resultados</p>`;
    return;
  }

  if (VIEW === 'groups') {
    const groups = [...DATA.groups].sort(sortGroups);
    grid.innerHTML = groups.map(cardGroup).join('') || `<p class="empty">Sin resultados</p>`;

    // Carruseles 2s
    [...grid.querySelectorAll('.card[data-type="lote"]')].forEach(card => {
      const pics = JSON.parse((card.dataset.pics || '[]').replace(/&[#]39;/g,"'"));
      if (!pics.length) return;
      const img  = card.querySelector('img.slide');
      const dots = [...card.querySelectorAll('.dot')];
      let i = 0;
      setInterval(() => {
        i = (i + 1) % pics.length;
        img.src = pics[i];
        dots.forEach((d,k)=>d.classList.toggle('active',k===i));
      }, 2000);
    });
    return;
  }

  // â€œTodoâ€ + Individual
  const items = DATA.items
    .filter(it => effectiveItemPrice(it) != null)
    .filter(it => !ONLY_NEW || isNew(it))
    .sort(sortItems);
  grid.innerHTML = items.map(cardItem).join('') || `<p class="empty">Sin resultados</p>`;
}

// ---------- Ingesta ----------
function renderShop(json){
  // ITEMS (Individual)
  const items = Array.isArray(json.items) ? json.items
    : (json.data && Array.isArray(json.data.items) ? json.data.items : []);
  DATA.items = items.map(x => ({
    id: x.id,
    name: x.name,
    image: x.image || x.img_url,
    price: x.price,                // puede ser null si solo en lote
    groupPrice: x.groupPrice,      // precio del lote (si viene)
    groupId: x.groupId || null,
    rarity: (x.rarity||'common').toLowerCase(),
    type: x.type,
    section: x.section || x.block || x.category || null,
    group: x.group || x.bundle || null,
    expires: x.expires || null,
    expiresISO: x.expiresISO || null,
    isNew: x.isNew === true || false  // placeholder por si ya viene marcado
  }));

  // GROUPS (Lotes)
  DATA.groups = Array.isArray(json.groups) ? json.groups.map(g => ({
    id: g.id,
    name: g.name,
    price: g.price,
    expires: g.expires || null,
    expiresISO: g.expiresISO || null,
    images: (g.images || []).filter(Boolean),
    items: (g.items||[]).map(it => ({
      name: it.name, image: it.image, rarity: (it.rarity||'common').toLowerCase(), type: it.type
    }))
  })) : [];

  // Mapas auxiliares
  GROUP_SIZE.clear(); GROUP_PRICE.clear();
  DATA.items.forEach(it => {
    if (it.groupId) {
      GROUP_SIZE.set(it.groupId, (GROUP_SIZE.get(it.groupId)||0) + 1);
      if (!GROUP_PRICE.has(it.groupId) && (it.groupPrice!=null)) GROUP_PRICE.set(it.groupId, it.groupPrice);
    }
  });
  DATA.groups.forEach(g => {
    GROUP_PRICE.set(g.id, GROUP_PRICE.get(g.id) ?? g.price);
    if (!GROUP_SIZE.has(g.id)) GROUP_SIZE.set(g.id, (g.items||[]).length || 0);
  });

  if (json.updatedAt) {
    try { dateEl.textContent = `Actualizado: ${new Date(json.updatedAt).toLocaleString()}`; }
    catch { dateEl.textContent = 'Actualizado'; }
  }
  render();
}

// ---------- Carga JSON ----------
fetch('/fortnite/shop.json?ts=' + Date.now(), { cache: 'no-store' })
  .then(r => r.json())
  .then(renderShop)
  .catch(e => {
    dateEl.textContent = 'No se pudo cargar la tienda.';
    console.error('Error cargando shop.json:', e);
  });
</script>
</body>
</html>






