<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Tienda de Fortnite — iEvan709</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Tienda diaria de Fortnite con precios, rarezas y filtros. Actualizada automáticamente." />
  <meta property="og:title" content="Tienda de Fortnite — iEvan709" />
  <meta property="og:description" content="Tienda diaria de Fortnite con precios, rarezas y filtros. Actualizada automáticamente." />
  <meta property="og:type" content="website" />
  <style>
    :root{
      --bg:#0b0f1a; --panel:#111726; --card:#141c2e;
      --txt:#e8ecf1; --muted:#9fb0c7;
      --rare-common:#888; --rare-uncommon:#29c059; --rare-rare:#3a82ff; --rare-epic:#a45bff; --rare-legendary:#ff8f2b; --rare-mythic:#ffd400;
      --ring: 10px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f1a,#0d1324 40%,#0b0f1a);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans',sans-serif}
    .wrap{max-width:1100px;margin:auto;padding:20px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .title h1{font-size:22px;margin:0}
    .title small{color:var(--muted)}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;background:#1a2236;color:#cfe0ff;cursor:pointer;border:1px solid #243150;font-size:13px}
    .chip.active{background:#244077;color:#fff;border-color:#2b57a3}
    .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
    @media (max-width:1200px){.grid{grid-template-columns:repeat(5,1fr)}}
    @media (max-width:980px){.grid{grid-template-columns:repeat(4,1fr)}}
    @media (max-width:760px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:520px){.grid{grid-template-columns:repeat(2,1fr)}}
    .card{background:var(--card);border-radius:14px;overflow:hidden;border:1px solid #1b2440;display:flex;flex-direction:column;min-height:240px;position:relative}
    .thumb{aspect-ratio:1/1;background:linear-gradient(180deg,#0f1629,#0a1124);display:flex;align-items:center;justify-content:center;position:relative}
    .thumb img{width:86%;height:86%;object-fit:contain;image-rendering:-webkit-optimize-contrast}
    .price{position:absolute;left:8px;top:8px;background:#101827cc;border:1px solid #1f2c4d;color:#fff;padding:4px 7px;border-radius:8px;font-size:12px}
    .badge{position:absolute;right:8px;top:8px;padding:4px 7px;border-radius:8px;border:1px solid #1f2c4d;background:#101827cc;font-size:12px}
    .meta{padding:10px 10px 12px}
    .name{font-size:14px;font-weight:600;line-height:1.2;margin-bottom:6px;min-height:34px}
    .sub{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:8px}
    /* aros por rareza */
    .ring{position:absolute;inset:0;pointer-events:none;border-radius:14px}
    .ring.common     {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-common) 46%, transparent)}
    .ring.uncommon   {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-uncommon) 38%, transparent)}
    .ring.rare       {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-rare) 34%, transparent)}
    .ring.epic       {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-epic) 34%, transparent)}
    .ring.legendary  {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-legendary) 32%, transparent)}
    .ring.mythic     {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-mythic) 30%, transparent)}
    .legend{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.common{background:var(--rare-common)} .dot.uncommon{background:var(--rare-uncommon)} .dot.rare{background:var(--rare-rare)}
    .dot.epic{background:var(--rare-epic)} .dot.legendary{background:var(--rare-legendary)} .dot.mythic{background:var(--rare-mythic)}
    .empty{opacity:.5}
    footer{margin:28px 0 8px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Tienda de Fortnite</h1>
        <small id="date">Cargando…</small>
      </div>
      <div class="legend">
  <span class="chip active" data-filter="all">Todo</span>
  <span class="chip" data-filter="traje">Traje</span>
  <span class="chip" data-filter="gesto">Gesto</span>
  <span class="chip" data-filter="pico">Pico</span>
  <span class="chip" data-filter="ala-delta">Ala delta</span>
  <span class="chip" data-filter="envoltorio">Envoltorio</span>
  <span class="chip" data-filter="mochila">Mochila</span>
  <span class="chip" data-filter="companero">Compañero</span>
  <span class="chip" data-filter="pista">Pistas</span>
      </div>
    </header>

    <div class="legend" style="margin:10px 0 18px">
      <span class="dot common"></span> Común
      <span class="dot uncommon"></span> Poco común
      <span class="dot rare"></span> Raro
      <span class="dot epic"></span> Épico
      <span class="dot legendary"></span> Legendario
      <span class="dot mythic"></span> Mítico
    </div>

    <section id="grid"></section>

    <footer>Fuente: Fortnite-API · Render por iEvan709</footer>
  </div>

  <script>
  const grid  = document.getElementById('grid');
  const dateEl = document.getElementById('date');
  const chips = Array.from(document.querySelectorAll('.chip'));
  let DATA = { items: [] }, FILTER = 'all';

  // Aliases por filtro (para que nunca queden vacíos)
  const FILTER_ALIASES = {
    'all': null,
    'traje': ['traje','outfit'],
    'gesto': ['gesto','emote','emoji','baile','dance'],
    'pico': ['pico','pickaxe','hacha'],
    'ala-delta': ['ala-delta','ala_delta','glider','planeador'],
    'envoltorio': ['envoltorio','wrap','weaponwrap'],
    'mochila': ['mochila','backpack','back-bling','back bling','accesorio','back'],
    'companero': ['companero','compañero','companion','buddy','pet','petcarrier','pet carrier'],
    'pista': ['pista','pistas','music','musicpack','athenamusicpack','jam','jamtrack','jam track','festival_track','improvisacion','improvisación','track']
  };

  // Orden de secciones como la tienda oficial
  const SECTION_ORDER = ['Featured','Special Featured','Special Daily','Daily'];

  chips.forEach(ch => ch.addEventListener('click', () => {
    chips.forEach(c => c.classList.remove('active'));
    ch.classList.add('active');
    FILTER = ch.dataset.filter;
    render();
  }));

  function priceFmt(p){
    if (p == null || p === "") return "¿?";
    const s = String(p);
    return /^\d+$/.test(s) ? `${s} V-Bucks` : s;
  }

  function rarityLabel(r){
    const map = {common:"Común",uncommon:"Poco común",rare:"Raro",epic:"Épico",legendary:"Legendario",mythic:"Mítico"};
    return map[r] || r || "—";
  }

  function normalizeType(t){
    if (!t) return 'traje';
    return String(t).toLowerCase().replace(/_/g,'-');
  }

  function matchesFilter(it){
    if (FILTER === 'all') return true;
    const ty = normalizeType(it.type || 'traje');
    const aliases = FILTER_ALIASES[FILTER] || [FILTER];
    return aliases.some(a => ty === a || ty.includes(a));
  }

  function card(it){
    const rar = (it.rarity||"common").toLowerCase();
    const ty  = normalizeType(it.type || "traje");
    return `
      <article class="card" data-type="${ty}">
        <div class="ring ${rar}"></div>
        <div class="thumb">
          <img loading="lazy" src="${it.img}" alt="${it.name}" onerror="this.closest('.card').classList.add('empty')" />
          <span class="price">${priceFmt(it.price)}</span>
          <span class="badge">${rarityLabel(rar)}</span>
        </div>
        <div class="meta">
          <div class="name">${it.name}</div>
          <div class="sub"><span>${ty}</span><span>Sale: ${it.expires||'—'}</span></div>
        </div>
      </article>`;
  }

  // Agrupa: Sección -> Bundle (group) -> Ítems. Si no hay sección, cae a tipo.
  function groupItems(items){
    const filtered = items.filter(matchesFilter);
    const hasSection = filtered.some(i => !!i.section);

    const buckets = new Map(); // key -> { section, group, items[] }

    if (hasSection){
      for (const it of filtered){
        const section = it.section || 'Tienda';
        const group = it.group || '';
        const key = section + '||' + group;
        if (!buckets.has(key)) buckets.set(key, { section, group, items: [] });
        buckets.get(key).items.push(it);
      }
    } else {
      for (const it of filtered){
        const ty = normalizeType(it.type);
        if (!buckets.has(ty)) buckets.set(ty, { section: ty, group: '', items: [] });
        buckets.get(ty).items.push(it);
      }
    }

    const arr = Array.from(buckets.values());
    arr.sort((a,b)=>{
      const ai = SECTION_ORDER.indexOf(a.section);
      const bi = SECTION_ORDER.indexOf(b.section);
      const as = ai === -1 ? 999 : ai;
      const bs = bi === -1 ? 999 : bi;
      if (as !== bs) return as - bs;
      // Dentro de sección: bundles primero y por nombre
      if (!!a.group !== !!b.group) return a.group ? -1 : 1;
      return (a.group||'').localeCompare(b.group||'');
    });

    return arr;
  }

  function render(){
    const groups = groupItems(DATA.items);
    if (!groups.length || groups.every(g => !g.items.length)){
      grid.innerHTML = `<div class="empty" style="padding:16px">Sin resultados para este filtro.</div>`;
      return;
    }
    const html = groups.map(g => `
      <div class="group">
        <h3 style="margin:12px 4px 8px;font-size:14px;color:#cfe0ff;">
          ${g.section}${g.group ? ' — ' + g.group : ''} <small style="color:#9fb0c7">(${g.items.length})</small>
        </h3>
        <div class="grid">
          ${g.items.map(card).join('')}
        </div>
      </div>
    `).join('');
    grid.innerHTML = html;
  }

  // Recibe JSON del backend y adapta campos
  function renderShop(json){
    const items = Array.isArray(json.items) ? json.items
                 : (json.data && Array.isArray(json.data.items) ? json.data.items : []);

    DATA.items = items.map(it => ({
      name   : it.name,
      img    : it.image || it.img_url,
      price  : it.price,
      rarity : (it.rarity || 'common').toLowerCase(),
      type   : it.type,
      expires: it.expires || null,
      section: it.section || null,  // Featured, Daily, etc.
      group  : it.group || null     // nombre del bundle/lote si hay
    }));

    if (json.updatedAt){
      try {
        const d = new Date(json.updatedAt);
        dateEl.textContent = `Actualizado: ${d.toLocaleString()}`;
      } catch { dateEl.textContent = 'Actualizado'; }
    } else {
      dateEl.textContent = '';
    }

    render();
  }

  // Asegúrate que el contenedor padre sea <section id="grid"></section> (sin class="grid")
  fetch('/fortnite/shop.json?ts=' + Date.now(), { cache: 'no-store' })
    .then(r => r.json())
    .then(renderShop)
    .catch(e => {
      dateEl.textContent = 'No se pudo cargar la tienda.';
      console.error('Error cargando shop.json:', e);
    });
</script>
</body>
</html>



