<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Tienda de Fortnite — iEvan709</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Tienda diaria de Fortnite con precios, rarezas y filtros. Actualizada automáticamente." />
  <meta property="og:title" content="Tienda de Fortnite — iEvan709" />
  <meta property="og:description" content="Tienda diaria de Fortnite con precios, rarezas y filtros. Actualizada automáticamente." />
  <meta property="og:type" content="website" />
  <style>
    :root{
      --bg:#0b0f1a; --panel:#111726; --card:#141c2e;
      --txt:#e8ecf1; --muted:#9fb0c7;
      --rare-common:#888; --rare-uncommon:#29c059; --rare-rare:#3a82ff; --rare-epic:#a45bff; --rare-legendary:#ff8f2b; --rare-mythic:#ffd400;
      --ring: 10px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f1a,#0d1324 40%,#0b0f1a);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans',sans-serif}
    .wrap{max-width:1100px;margin:auto;padding:20px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .title h1{font-size:22px;margin:0}
    .title small{color:var(--muted)}
    .chip{padding:8px 12px;border-radius:999px;background:#1a2236;color:#cfe0ff;cursor:pointer;border:1px solid #243150;font-size:13px}
    .chip.active{background:#244077;color:#fff;border-color:#2b57a3}

    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap:12px; }

    .card{
      background:var(--card); border-radius:14px; overflow:hidden; border:1px solid #1b2440;
      display:flex; flex-direction:column; min-height:240px; position:relative;
    }

    .thumb{ position:relative; width:100%; padding-top:100%; background:linear-gradient(180deg,#0f1629,#0a1124); overflow:hidden; }
    .thumb img{ position:absolute; top:7%; left:7%; width:86%; height:86%; object-fit:contain; max-width:100%; max-height:100%; image-rendering:-webkit-optimize-contrast; }

    .price{position:absolute;left:8px;top:8px;background:#101827cc;border:1px solid #1f2c4d;color:#fff;padding:4px 7px;border-radius:8px;font-size:12px;z-index:2}
    .badge{position:absolute;right:8px;top:8px;padding:4px 7px;border-radius:8px;border:1px solid #1f2c4d;background:#101827cc;font-size:12px;z-index:2}
    .meta{padding:10px 10px 12px}
    .name{font-size:14px;font-weight:600;line-height:1.2;margin-bottom:6px;min-height:34px}
    .sub{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:8px}

    .ring{position:absolute;inset:0;pointer-events:none;border-radius:14px}
    .ring.common     {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-common) 46%, transparent)}
    .ring.uncommon   {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-uncommon) 38%, transparent)}
    .ring.rare       {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-rare) 34%, transparent)}
    .ring.epic       {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-epic) 34%, transparent)}
    .ring.legendary  {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-legendary) 32%, transparent)}
    .ring.mythic     {box-shadow: inset 0 0 0 var(--ring) color-mix(in oklab, var(--rare-mythic) 30%, transparent)}

    .legend{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.common{background:var(--rare-common)} .dot.uncommon{background:var(--rare-uncommon)} .dot.rare{background:var(--rare-rare)}
    .dot.epic{background:var(--rare-epic)} .dot.legendary{background:var(--rare-legendary)} .dot.mythic{background:var(--rare-mythic)}
    .empty{opacity:.6;padding:12px 6px}
    footer{margin:28px 0 8px;color:var(--muted);font-size:12px}

    /* barra de vista */
    .viewbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}

    /* carrusel (fade) */
    .carousel{
      position:absolute; inset:7% 7% 7% 7%;
      display:grid; place-items:center;
    }
    .carousel img{
      position:absolute; width:86%; height:86%; object-fit:contain; opacity:0; transition:opacity .4s ease;
    }
    .carousel img.active{ opacity:1; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Tienda de Fortnite</h1>
        <small id="date">Cargando…</small>
      </div>
      <div class="legend">
        <span class="chip active" data-filter="all">Todo</span>
        <span class="chip" data-filter="traje">Traje</span>
        <span class="chip" data-filter="gesto">Gesto</span>
        <span class="chip" data-filter="pico">Pico</span>
        <span class="chip" data-filter="ala-delta">Ala delta</span>
        <span class="chip" data-filter="envoltorio">Envoltorio</span>
        <span class="chip" data-filter="mochila">Mochila</span>
        <span class="chip" data-filter="companero">Compañero</span>
        <span class="chip" data-filter="pista">Pistas</span>
      </div>
    </header>

    <div class="legend" style="margin:10px 0 8px">
      <span class="dot common"></span> Común
      <span class="dot uncommon"></span> Poco común
      <span class="dot rare"></span> Raro
      <span class="dot epic"></span> Épico
      <span class="dot legendary"></span> Legendario
      <span class="dot mythic"></span> Mítico
    </div>

    <!-- Toggle de vista (solo visible en "Todo") -->
    <div class="viewbar" id="viewbar">
      <span class="chip chip-view active" data-view="groups">Lotes</span>
      <span class="chip chip-view" data-view="individual">Individual</span>
    </div>

    <section class="grid" id="grid"></section>

    <footer>Fuente: Fortnite-API · Render por iEvan709</footer>
  </div>

  <script>
  const grid   = document.getElementById('grid');
  const dateEl = document.getElementById('date');
  const viewBar= document.getElementById('viewbar');

  const chips      = Array.from(document.querySelectorAll('.chip[data-filter]'));
  const viewChips  = Array.from(document.querySelectorAll('.chip-view'));

  // Estado
  let FILTER = 'all';        // 'all' | 'traje' | 'gesto' | etc
  let VIEW   = 'groups';     // 'groups' | 'individual' (solo válido si FILTER==='all')
  const DATA = { items: [], groups: [] };

  // Orden
  const RARITY_ORDER = { mythic:0, legendary:1, epic:2, rare:3, uncommon:4, common:5 };
  const TYPE_ORDER   = { traje:0, gesto:1, pico:2, 'ala-delta':3, envoltorio:4, mochila:5, companero:6, pista:7 };
  const SEC_ORDER = s => ({'Featured':0,'Special Featured':1,'Special Daily':2,'Daily':3,'Votes':4,'Vote Winners':5})[s] ?? 9;

  // Carruseles activos para limpiar en cada render
  let carouselTimers = [];

  function priceFmt(p){
    if (p == null || p === "") return "¿?";
    const s = String(p); return /^\d+$/.test(s) ? `${s} V-Bucks` : s;
  }
  function rarityLabel(r){
    const map = {common:"Común",uncommon:"Poco común",rare:"Raro",epic:"Épico",legendary:"Legendario",mythic:"Mítico"};
    return map[r] || r || "—";
  }
  function normalizeType(obj){
    let t = (obj.type || '').toString().toLowerCase().replace('_','-').trim();
    if (!t) {
      const n = (obj.name||'').toLowerCase();
      if (/(compañer|compan|buddy|pet)/.test(n)) t = 'companero';
      else if (/(pista|improvis|jam|track|music|música|musica)/.test(n)) t = 'pista';
      else if (/(gesto|emote|baile|dance)/.test(n)) t = 'gesto';
      else if (/(pico|hacha|pickaxe)/.test(n)) t = 'pico';
      else if (/(glider|planeador|ala( )?delta|^ala$)/.test(n)) t = 'ala-delta';
      else if (/(envoltorio|wrap|camo)/.test(n)) t = 'envoltorio';
      else if (/(mochila|back bling|backbling|accesorio)/.test(n)) t = 'mochila';
      else t = 'traje';
    }
    if (t === 'ala_delta') t = 'ala-delta';
    if (t === 'mascota')   t = 'companero';
    return t;
  }
  function by(a,b){ return a<b?-1:a>b?1:0; }

  // Listeners de filtro
  chips.forEach(ch => ch.addEventListener('click', () => {
    chips.forEach(c => c.classList.remove('active'));
    ch.classList.add('active');
    FILTER = ch.dataset.filter;

    // La barra de vista solo existe en "Todo"
    if (FILTER === 'all') {
      viewBar.style.display = 'flex';
    } else {
      viewBar.style.display = 'none';
      VIEW = 'individual'; // fuerza individual en categorías
      viewChips.forEach(c => c.classList.remove('active'));
    }
    render();
  }));

  // Listeners de vista
  viewChips.forEach(ch => ch.addEventListener('click', () => {
    if (FILTER !== 'all') return; // ignorar si no es "Todo"
    viewChips.forEach(c => c.classList.remove('active'));
    ch.classList.add('active');
    VIEW = ch.dataset.view;
    render();
  }));

  // --- Render helpers

  function formatDate(expiresISO, fallbackText){
    if (expiresISO && typeof expiresISO === 'string' && expiresISO.includes('-')) {
      try {
        const d = new Date(expiresISO);
        if (!isNaN(d)) {
          return d.toLocaleDateString(undefined, { day:'2-digit', month:'2-digit', year:'numeric' });
        }
      } catch {}
    }
    return fallbackText || '';
  }

  function cardItem(it){
    const rar = (it.rarity||"common").toLowerCase();
    const ty  = normalizeType(it);
    if (FILTER !== 'all' && ty !== FILTER) return '';
    const img = it.image || it.img || it.img_url;
    if (!img) return '';

    const when = formatDate(it.expiresISO, it.expires ? String(it.expires) : '');
    return `
      <article class="card" data-type="${ty}">
        <div class="ring ${rar}"></div>
        <div class="thumb">
          <img loading="lazy" src="${img}" alt="${it.name}"
               onerror="this.closest('.card').classList.add('empty')" />
          <span class="price">${priceFmt(it.price)}</span>
          <span class="badge">${rarityLabel(rar)}</span>
        </div>
        <div class="meta">
          <div class="name">${it.name}</div>
          <div class="sub">
            <span>${ty}${it.group ? ` · ${it.group}`:''}</span>
            <span>${when ? `Sale: ${when}` : ''}</span>
          </div>
        </div>
      </article>`;
  }

  function cardGroup(g){
    // La vista de grupos solo existe en "Todo"; si te forzan otro filtro, no se renderiza.
    if (FILTER !== 'all') return '';
    const pics = Array.isArray(g.images) ? g.images.filter(Boolean) : [];
    const leadImg = pics[0] || ((g.items && g.items[0] && (g.items[0].image || g.items[0].img_url)) || '');
    if (!leadImg) return '';

    const rar  = ((g.items && g.items[0] && g.items[0].rarity) || 'common').toLowerCase();
    const total = (g.items||[]).length;
    const name = g.name ? `${g.name} (Lote)` : `${(g.items && g.items[0] && g.items[0].name) || 'Lote'} (Lote)`;
    const when = formatDate(g.expiresISO, g.expires ? String(g.expires) : '');

    // carrusel con <img> múltiples (fade)
    const imgsHtml = pics.slice(0,8).map((src,i)=>`<img ${i===0?'class="active"':''} src="${src}" alt="${name}">`).join('');

    return `
      <article class="card" data-type="lote" data-carousel="true" data-images="${encodeURIComponent(JSON.stringify(pics.slice(0,8)))}">
        <div class="ring ${rar}"></div>
        <div class="thumb">
          <div class="carousel">
            ${imgsHtml}
          </div>
          <span class="price">${priceFmt(g.price)}</span>
          <span class="badge">Lote · ${total} item${total===1?'':'s'}</span>
        </div>
        <div class="meta">
          <div class="name">${name}</div>
          <div class="sub">
            <span>Incluye ${total}</span>
            <span>${when ? `Sale: ${when}` : ''}</span>
          </div>
        </div>
      </article>`;
  }

  function sortItems(a,b){
    // Orden fuerte por sección, luego tipo, luego rareza, luego nombre
    const sa = SEC_ORDER(a.section||''), sb = SEC_ORDER(b.section||'');
    if (sa !== sb) return sa - sb;

    const ta = TYPE_ORDER[normalizeType(a)] ?? 99;
    const tb = TYPE_ORDER[normalizeType(b)] ?? 99;
    if (ta !== tb) return ta - tb;

    const ra = RARITY_ORDER[(a.rarity||'').toLowerCase()] ?? 9;
    const rb = RARITY_ORDER[(b.rarity||'').toLowerCase()] ?? 9;
    if (ra !== rb) return ra - rb;

    return by((a.name||'').toLowerCase(), (b.name||'').toLowerCase());
  }
  function sortGroups(a,b){
    // Heurística simple: Featured primero, luego por precio descendente, luego nombre
    const sa = SEC_ORDER(a.section||''), sb = SEC_ORDER(b.section||'');
    if (sa !== sb) return sa - sb;
    const pa = Number(a.price ?? 0), pb = Number(b.price ?? 0);
    if (pa !== pb) return pb - pa; // mayor precio arriba (proxy de “popularidad”)
    return by((a.name||'').toLowerCase(), (b.name||'').toLowerCase());
  }

  function uniqueById(items){
    const seen = new Set();
    const out = [];
    for (const it of items){
      const id = it.id || `${it.name}|${it.image||it.img_url}`;
      if (seen.has(id)) continue;
      seen.add(id);
      out.push(it);
    }
    return out;
  }

  function clearCarousels(){
    for (const t of carouselTimers) clearInterval(t);
    carouselTimers = [];
  }

  function bootCarousels(){
    const cards = grid.querySelectorAll('article[data-carousel="true"] .carousel');
    cards.forEach(car => {
      const imgs = car.querySelectorAll('img');
      if (!imgs.length) return;
      let idx = 0;
      const tick = () => {
        imgs.forEach((im,i)=> im.classList.toggle('active', i===idx));
        idx = (idx+1) % imgs.length;
      };
      // ya hay un activo, empieza a rotar a los 2s
      const timer = setInterval(tick, 2000);
      carouselTimers.push(timer);
    });
  }

  function render(){
    // Limpia carruseles anteriores para evitar timers duplicados
    clearCarousels();

    // Vista “Todo”
    if (FILTER === 'all') {
      if (VIEW === 'groups') {
        // Lotes primero (por definición)
        // Adjuntamos sección estimada al grupo usando la de su primer item (para orden)
        const groups = [...DATA.groups].map(g=>{
          const sec = (g.items && g.items[0] && g.items[0].section) || null;
          return {...g, section: sec};
        }).sort(sortGroups);
        const html = groups.map(cardGroup).join('');
        grid.innerHTML = html || `<p class="empty">Sin resultados</p>`;
        bootCarousels();
        return;
      } else {
        // Todo + Individual (deduplicado)
        const items = uniqueById([...DATA.items]).sort(sortItems);
        grid.innerHTML = items.map(cardItem).join('') || `<p class="empty">Sin resultados</p>`;
        return;
      }
    }

    // Vistas por categoría (siempre individual, sin lotes)
    const items = uniqueById([...DATA.items]).filter(it => normalizeType(it) === FILTER).sort(sortItems);
    grid.innerHTML = items.map(cardItem).join('') || `<p class="empty">Sin resultados</p>`;
  }

  // Ingesta JSON
  function renderShop(json){
    // ITEMS
    const rawItems = Array.isArray(json.items) ? json.items
      : (json.data && Array.isArray(json.data.items) ? json.data.items : []);
    DATA.items = rawItems.map(x => ({
      id: x.id,
      name: x.name,
      image: x.image || x.img_url,
      price: x.price,
      rarity: (x.rarity||'common').toLowerCase(),
      type: x.type,
      section: x.section || x.block || x.category || null,
      group: x.group || x.bundle || null,
      expires: x.expires,
      expiresISO: x.expiresISO || null,
    }));

    // GROUPS (lotes)
    const rawGroups = Array.isArray(json.groups) ? json.groups : [];
    DATA.groups = rawGroups.map(g => ({
      id: g.id,
      name: g.name,
      price: g.price,
      expires: g.expires,
      expiresISO: g.expiresISO || null,
      images: Array.isArray(g.images) ? g.images.filter(Boolean).slice(0,8) : [],
      // Guarda sección del primer ítem (si vino) para ayudar a ordenar
      items: (g.items||[]).map(it => ({
        name: it.name,
        image: it.image || it.img_url,
        rarity: (it.rarity||'common').toLowerCase(),
        type: it.type,
        section: it.section || null
      }))
    }));

    // Fecha
    if (json.updatedAt) {
      try { dateEl.textContent = `Actualizado: ${new Date(json.updatedAt).toLocaleString()}`; }
      catch { dateEl.textContent = 'Actualizado'; }
    }

    // Estado inicial: Todo + Lotes
    FILTER = 'all';
    VIEW = 'groups';
    // UI inicial
    chips.forEach(c => c.classList.toggle('active', c.dataset.filter==='all'));
    viewBar.style.display = 'flex';
    viewChips.forEach(c => c.classList.toggle('active', c.dataset.view==='groups'));

    render();
  }

  // fetch
  fetch('/fortnite/shop.json?ts=' + Date.now(), { cache: 'no-store' })
    .then(r => r.json())
    .then(renderShop)
    .catch(e => {
      dateEl.textContent = 'No se pudo cargar la tienda.';
      console.error('Error cargando shop.json:', e);
    });
  </script>
</body>
</html>
